name: Network Configuration CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch: # Manual trigger

jobs:
  validate-configuration:
    name: Validate Configuration
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Validate JSON syntax
        run: |
          echo "üîç Validating configuration files..."
          python -m json.tool configs/network_config.json
          python -m json.tool configs/vlan_config.json
          echo "‚úÖ All configuration files are valid"

      - name: Show deployment plan
        run: |
          echo "üöÄ IOS XR Deployment Plan:"
          echo "--------------------------"
          echo "Target: sandbox-iosxr-1.cisco.com"
          echo "VLANs to be created:"
          python3 -c "
          import json
          with open('configs/vlan_config.json') as f:
              config = json.load(f)
              for subif in config['subinterfaces']:
                  print(f'  - {subif[\"subinterface\"]}: VLAN {subif[\"vlan_id\"]}')
          "
          echo ""
          echo "Routing Protocols:"
          python3 -c "
          import json
          with open('configs/vlan_config.json') as f:
              config = json.load(f)
              if 'routing_protocols' in config:
                  for proto in config['routing_protocols']:
                      print(f'  - {proto[\"protocol\"].upper()} Process {proto[\"process_id\"]}')
          "

  deploy-to-iosxr:
    name: Deploy to IOS XR Sandbox
    runs-on: ubuntu-latest
    needs: validate-configuration

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      - name: Install dependencies
        run: |
          pip install -r scripts/requirements.txt

      - name: Deploy to IOS XR Sandbox
        run: |
          echo "üéØ Deploying to Cisco IOS XRv9000 Sandbox..."
          echo "üìç Target: sandbox-iosxr-1.cisco.com"
          echo "üì¢ REMEMBER: This is a SHARED sandbox - be respectful!"
          cd scripts
          python iosxr_network_ops.py
        env:
          SWITCH_IP: ${{ secrets.IOSXR_IP }}
          SWITCH_USERNAME: ${{ secrets.IOSXR_USERNAME }}
          SWITCH_PASSWORD: ${{ secrets.IOSXR_PASSWORD }}
          SWITCH_ENABLE_PASSWORD: ${{ secrets.IOSXR_ENABLE_PASSWORD }}

      - name: Deployment summary
        run: |
          echo "üéâ IOS XR deployment completed successfully!"
          echo "üìç Switch: ${{ secrets.IOSXR_IP }}"
          echo "üïí Timestamp: $(date)"
