name: Network Configuration CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch: # Manual trigger

jobs:
  validate-configuration:
    name: Validate Configuration
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Validate JSON syntax
        run: |
          echo "...............Validating configuration files..."
          python -m json.tool configs/network_config.json
          python -m json.tool configs/vlan_config.json
          echo "All configuration files are valid"

      - name: Show deployment plan
        run: |
          echo "IOS XR Deployment Plan:"
          echo "--------------------------"
          echo "Target: sandbox-iosxr-1.cisco.com"
          echo "VLANs to be created:"
          python3 -c "
          import json
          with open('configs/vlan_config.json') as f:
              config = json.load(f)
              for subif in config['subinterfaces']:
                  print(f'  - {subif[\"subinterface\"]}: VLAN {subif[\"vlan_id\"]}')
          "

    deploy-to-iosxr:
    name: Deploy to IOS XR Sandbox
    runs-on: ubuntu-latest
    needs: validate-configuration
    if: github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
      
    - name: Install dependencies
      run: |
        pip install -r scripts/requirements.txt
      
    - name: Deploy to IOS XR Sandbox
      run: |
        echo "Deploying to Cisco IOS XRv9000 Sandbox..."
        echo "Target: sandbox-iosxr-1.cisco.com"
        echo "REMEMBER: This is a SHARED sandbox - be respectful!"
        cd scripts
        python iosxr_network_ops.py
      env:
        SWITCH_IP: ${{ secrets.IOSXR_IP }}
        SWITCH_USERNAME: ${{ secrets.IOSXR_USERNAME }}
        SWITCH_PASSWORD: ${{ secrets.IOSXR_PASSWORD }}
        SWITCH_ENABLE_PASSWORD: ${{ secrets.IOSXR_ENABLE_PASSWORD }}
      
    - name: Deployment summary
      run: |
        echo "IOS XR deployment completed successfully!"
        echo "Switch: ${{ secrets.IOSXR_IP }}"
        echo "Timestamp: $(date)"