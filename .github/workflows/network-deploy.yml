name: Network Configuration CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch: # Manual trigger

jobs:
  validate-configuration:
    name: Validate Configuration
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Validate JSON syntax
        run: |
          echo "üîç Validating configuration files..."
          python -m json.tool configs/network_config.json
          python -m json.tool configs/vlan_config.json
          echo "‚úÖ All configuration files are valid"

      - name: Show deployment plan
        run: |
          echo "üöÄ Deployment Plan:"
          echo "-------------------"
          echo "VLANs to be created:"
          python3 -c "
          import json
          with open('configs/vlan_config.json') as f:
              config = json.load(f)
              for vlan in config['vlans']:
                  print(f'  - VLAN {vlan[\"id\"]}: {vlan[\"name\"]}')
          "
          echo ""
          echo "Interfaces to be configured:"
          python3 -c "
          import json
          with open('configs/vlan_config.json') as f:
              config = json.load(f)
              for interface in config['interfaces']:
                  print(f'  - {interface[\"interface\"]}: {interface[\"description\"]}')
          "

  deploy-network:
    name: Deploy Network Configuration
    runs-on: ubuntu-latest
    needs: validate-configuration
    if: github.event_name == 'workflow_dispatch' # Manual deployment only

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      - name: Install dependencies
        run: |
          pip install -r scripts/requirements.txt

      - name: Deploy network configuration
        run: |
          cd scripts
          python network_ops.py
        env:
          SWITCH_IP: ${{ secrets.SWITCH_IP }}
          SWITCH_USERNAME: ${{ secrets.SWITCH_USERNAME }}
          SWITCH_PASSWORD: ${{ secrets.SWITCH_PASSWORD }}
          SWITCH_ENABLE_PASSWORD: ${{ secrets.SWITCH_ENABLE_PASSWORD }}

      - name: Deployment summary
        run: |
          echo "üéâ Network deployment completed successfully!"
          echo "Switch: ${{ secrets.SWITCH_IP }}"
          echo "Timestamp: $(date)"
